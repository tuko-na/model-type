# Model Type - 機能紹介

本ドキュメントでは、Model Typeアプリケーションの各機能について詳しく解説します。

---

## 📋 目次

1. [概要](#概要)
2. [ダッシュボード機能](#ダッシュボード機能)
   - [ポータルダッシュボード（マイページ）](#ポータルダッシュボードマイページ)
   - [パブリックダッシュボード（集合知分析）](#パブリックダッシュボード集合知分析)
3. [製品管理機能](#製品管理機能)
   - [製品登録](#製品登録)
   - [楽天API連携](#楽天api連携)
   - [自己成長型辞書](#自己成長型辞書)
4. [インシデント管理機能](#インシデント管理機能)
   - [インシデント登録](#インシデント登録)
   - [動的フォームスキーマ](#動的フォームスキーマ)
   - [インシデント編集](#インシデント編集)
5. [統計・分析機能](#統計分析機能)
   - [信頼性スコア](#信頼性スコア)
   - [CPD（Cost Per Day）計算](#cpdcost-per-day計算)
   - [寿命分析](#寿命分析)
   - [レーダーチャート比較](#レーダーチャート比較)
6. [グループ管理機能](#グループ管理機能)
7. [データモデル](#データモデル)

---

## 概要

**Model Type**は、製品を「型番（model_number）」をキーとして管理し、インシデント（故障・メンテナンス履歴）を記録・可視化するWebアプリケーションです。

### コンセプト

- **カタログスペック**（CPU、重量など）ではなく、**実績スペック**（実際の寿命、維持費）を可視化
- 個人の主観による「レビュー」ではなく、**数字（データ）**に基づいた客観的な評価
- 集合知を活用した製品の信頼性分析

---

## ダッシュボード機能

### ポータルダッシュボード（マイページ）

**ファイル:** `app/Livewire/PortalDashboard.php`  
**ルート:** `/dashboard`（認証必須）

自分のグループが所有する製品を管理・分析するダッシュボードです。

#### 主な機能

| 機能 | 説明 |
|:---|:---|
| **製品一覧表示** | グループに属する製品を検索・一覧表示 |
| **製品詳細分析** | 選択した製品のインシデント履歴や統計を表示 |
| **グローバルKPI** | 平均寿命、年間メンテナンスコスト、故障率を表示 |
| **フォーカスモニター** | 選択製品の詳細データをリアルタイム表示 |

#### グローバルKPI指標

```
avg_lifespan         - 全製品の平均使用年数
annual_maintenance_cost - 過去1年間のメンテナンス総額
incident_rate        - インシデント発生率（%）
```

---

### パブリックダッシュボード（集合知分析）

**ファイル:** `app/Livewire/PublicDashboard.php`  
**ルート:** `/public`（認証必須）

全ユーザーのデータを集約し、型番ベースで製品の信頼性を分析するダッシュボードです。

#### 主な機能

| 機能 | 説明 |
|:---|:---|
| **型番検索** | 型番・製品名・メーカー名で製品を検索 |
| **サンプル数表示** | 同型番の登録台数を表示 |
| **製品比較** | 最大3製品を並べて比較 |
| **カテゴリフィルタ** | スマートフォン、ノートPC、テレビなどで絞り込み |

#### 分析指標

| 指標 | 説明 |
|:---|:---|
| **信頼性スコア** | `100 - 故障率`（%） |
| **CPD** | 1日あたりの総コスト（購入価格 + 修理費用 ÷ 使用日数） |
| **平均寿命** | 同型番製品の平均使用年数 |
| **1年故障率** | 購入後1年以内に故障した割合 |
| **平均修理費用** | インシデント発生時の平均コスト |

#### 可視化データ

- **インシデント種別分布**: 故障/メンテナンス/破損/紛失の割合
- **深刻度分布**: 軽微/中程度/重大/致命的の割合
- **発生時期パターン**: 購入後何ヶ月で問題が起きやすいか
- **寿命分布**: 0-1年、1-2年、2-3年...のヒストグラム
- **コスト推移**: 時期別メンテナンスコスト
- **よくある問題TOP5**: 最も多いインシデント種別とコスト

---

## 製品管理機能

### 製品登録

**ファイル:** `app/Livewire/CreateProduct.php`  
**ルート:** `/products/create`（認証必須）

#### ステップ式登録フロー

1. **ステップ1: 検索**
   - DB内既存製品の検索
   - 楽天API経由での製品サジェスト
   
2. **ステップ2: 詳細入力**
   - 製品情報の入力・確認
   - 購入条件、保証期限などの追加情報

#### 入力項目

| フィールド | 説明 | 必須 |
|:---|:---|:---:|
| `name` | 製品名 | ✓ |
| `model_number` | 型番 | ✓ |
| `manufacturer` | メーカー名 | ✓ |
| `genre_name` | ジャンル（カテゴリ） | ✓ |
| `purchase_date` | 購入日 | ✓ |
| `purchase_condition` | 購入状態（新品/中古/再生品/不明） | ✓ |
| `status` | ステータス（active/in_storage/in_repair/disposed） | ✓ |
| `price` | 購入価格 | - |
| `warranty_expires_on` | 保証期限 | - |
| `useful_life` | 想定使用年数 | - |
| `notes` | メモ | - |

#### ジャンルカテゴリ

```php
const GENRE_CATEGORIES = [
    'キッチン家電' => [
        '調理器具（炊飯器・電子レンジ等）',
        '飲料・コーヒー関連',
        'フードプロセッサー類',
        '大型家電（冷蔵庫・冷凍庫等）',
        'キッチン家電その他',
    ],
    '生活家電' => [...],
    '季節・空調家電' => [...],
    '美容・健康家電' => [...],
    'AV機器・カメラ・デジタル家電' => [...],
];
```

---

### 楽天API連携

**ファイル:** `app/Services/RakutenApiService.php`

製品登録時に楽天APIから製品情報をサジェストします。

#### 検索フロー

1. **製品検索API（商品価格ナビ）** を優先的に使用
2. ヒットしない場合は **商品検索API（楽天市場）** にフォールバック

#### 取得情報

| フィールド | 説明 |
|:---|:---|
| `product_name` | 製品名 |
| `maker_name` | メーカー名 |
| `model_number` | 型番（製品APIのみ） |
| `genre_id` | 楽天ジャンルID |
| `genre_name` | ジャンル名 |
| `rakuten_url` | 楽天製品ページURL |
| `_display_image` | サムネイル画像URL |
| `_display_price` | 参考価格 |

#### デモモード

ローカル環境で `demo_mode` が有効な場合、モックデータを返却します。

---

### 自己成長型辞書

**モデル:** `app/Models/ModelSuggestion.php`

ユーザーが製品を登録するたびに、型番と製品情報の組み合わせを辞書として蓄積します。

#### メリット

- **入力コストの最小化**: 次回から同じ型番で自動補完
- **データ品質の統一**: 表記ゆれを防止
- **集合知の蓄積**: 全ユーザーで共有される資産

---

## インシデント管理機能

### インシデント登録

**ファイル:** `app/Livewire/CreateIncident.php`  
**ルート:** `/incidents/create`（認証必須）

#### ウィザード形式（3ステップ）

| ステップ | 内容 |
|:---:|:---|
| **0** | 製品選択（検索で自分のグループの製品を選択） |
| **1** | 基本情報（発生日、種別、深刻度、タイトル） |
| **2** | 詳細情報（カテゴリ別の動的フォーム） |
| **3** | 解決方法・コスト（対応方法、症状タグ、費用） |

#### インシデント種別

```php
const INCIDENT_TYPES = [
    'failure'     => '故障',
    'maintenance' => 'メンテナンス',
    'damage'      => '破損',
    'loss'        => '紛失',
];
```

#### 解決種別

```php
const RESOLUTION_TYPES = [
    'repair'        => '修理',
    'replacement'   => '交換',
    'self_resolved' => '自己解決',
    'unresolved'    => '未対応',
];
```

#### 深刻度レベル

| キー | ラベル | カラー |
|:---|:---|:---|
| `low` | 軽微 | 🟢 green |
| `medium` | 中程度 | 🟡 yellow |
| `high` | 重大 | 🟠 orange |
| `critical` | 致命的 | 🔴 red |

#### 症状タグ

```php
const SYMPTOM_TAGS = [
    'power_issue'     => '電源が入らない',
    'strange_noise'   => '異音がする',
    'no_response'     => '反応しない',
    'physical_damage' => '物理的な損傷',
    'software_glitch' => 'ソフトウェアの不具合',
];
```

---

### 動的フォームスキーマ

**ディレクトリ:** `app/Services/IncidentFormSchema/`

製品のカテゴリ（ジャンル）に応じて、インシデント詳細入力フォームを動的に切り替えます。

#### Strategy Pattern

```php
FormSchemaFactory::getFields($category)
```

#### 対応カテゴリ

| カテゴリ | スキーマクラス | 対象製品 |
|:---|:---|:---|
| **Smartphone** | `SmartphoneSchema` | スマートフォン、タブレット、iPad |
| **PC** | `PCSchema` | ノートPC、デスクトップ、MacBook |
| **Audio** | `AudioSchema` | ヘッドホン、スピーカー、アンプ |
| **HomeAppliance** | `HomeApplianceSchema` | テレビ、冷蔵庫、洗濯機、エアコン |
| **Default** | `DefaultSchema` | その他すべて |

#### カテゴリ別マッピング例

```php
protected static array $categoryMap = [
    'smartphone' => SmartphoneSchema::class,
    'iphone'     => SmartphoneSchema::class,
    'ipad'       => SmartphoneSchema::class,
    'laptop'     => PCSchema::class,
    'macbook'    => PCSchema::class,
    'headphone'  => AudioSchema::class,
    'tv'         => HomeApplianceSchema::class,
    // ...
];
```

---

### インシデント編集

**ファイル:** `app/Livewire/EditIncident.php`  
**ルート:** `/incidents/{incident}/edit`（認証必須）

登録済みインシデントの編集機能。CreateIncidentと同様のウィザード形式UIを提供。

#### 機能

- 既存データのプリロード
- 症状タグの解析と復元
- 動的フォームスキーマの再適用
- グループ権限チェック

---

## 統計・分析機能

### 信頼性スコア

同型番製品における故障率の逆数として計算。

```php
$incidentRate = ($productsWithIncidents / $sampleCount) * 100;
$reliabilityScore = max(0, 100 - $incidentRate);
```

**例:** 10台中2台にインシデントがあれば、信頼性スコア = 80

---

### CPD（Cost Per Day）計算

製品の1日あたりの総コストを算出し、コストパフォーマンスを評価。

```php
$days = Carbon::parse($purchase_date)->diffInDays(now());
$totalCost = $price + $incidents->sum('cost');
$cpd = $totalCost / max(1, $days);
```

**用途:** 製品比較時の経済性評価

---

### 寿命分析

#### 寿命分布

購入からの経過年数をバケット化して集計。

```
0-1年, 1-2年, 2-3年, 3-4年, 4年以上
```

#### カテゴリ平均寿命

製品カテゴリごとの標準寿命（参考値）。

```php
protected array $categoryLifespans = [
    'Smartphone' => 3,  // 3年
    'Laptop'     => 4,  // 4年
    'Tablet'     => 3,  // 3年
    'TV'         => 7,  // 7年
    'Appliance'  => 10, // 10年
    'Other'      => 5,  // 5年
];
```

---

### レーダーチャート比較

選択製品と全体平均を4軸で比較。

| 軸 | 計算方法 |
|:---|:---|
| **信頼性** | 100 - 故障率 |
| **コスパ** | 100 - (CPD / 2) |
| **寿命** | (平均使用年数 / カテゴリ平均寿命) × 100 |
| **修理費用** | 全体平均との相対評価 |

```php
'radar_comparison' => [
    'labels' => ['信頼性', 'コスパ', '寿命', '修理費用'],
    'product' => [...],  // 選択製品のスコア
    'baseline' => [...], // 全体平均のスコア
]
```

---

## グループ管理機能

**モデル:** `app/Models/Group.php`

ユーザーはグループに所属し、グループ単位で製品を管理します。

#### リレーション

```
Group ─┬─ hasMany ─> Product
       └─ belongsToMany ─> User
```

#### 用途

- 家族での製品共有管理
- 法人・チームでの資産管理
- プライベートモードでのデータ分離

---

## データモデル

### ER図（概念）

```
┌────────────┐     ┌────────────┐     ┌────────────┐
│   Group    │────<│  Product   │────<│  Incident  │
└────────────┘     └────────────┘     └────────────┘
      │                                      │
      │            ┌────────────┐            │
      └───────────>│    User    │<───────────┘
                   └────────────┘
```

### 主要テーブル

| テーブル | 説明 |
|:---|:---|
| `users` | ユーザー情報 |
| `groups` | グループ（製品の所有単位） |
| `group_user` | ユーザー・グループ中間テーブル |
| `products` | 製品情報（型番、購入情報など） |
| `incidents` | インシデント記録（故障、メンテナンス履歴） |
| `model_suggestions` | 自己成長型辞書（型番サジェスト用） |

---

## 技術スタック

| カテゴリ | 技術 |
|:---|:---|
| **言語** | PHP 8.2+ |
| **フレームワーク** | Laravel 12 |
| **フロントエンド** | Livewire, Tailwind CSS |
| **データベース** | SQLite（開発）, MySQL/PostgreSQL（本番） |
| **ビルドツール** | Vite, PostCSS |
| **テスト** | Pest |

---

## ルート一覧

| ルート | メソッド | 機能 |
|:---|:---:|:---|
| `/` | GET | ウェルカムページ |
| `/dashboard` | GET | ポータルダッシュボード |
| `/public` | GET | パブリックダッシュボード |
| `/products/create` | GET | 製品登録（Livewire） |
| `/products` | GET | 製品一覧 |
| `/products/{id}` | GET | 製品詳細 |
| `/incidents` | GET | インシデント一覧 |
| `/incidents/create` | GET | インシデント登録（Livewire） |
| `/incidents/{id}/edit` | GET | インシデント編集（Livewire） |
| `/profile` | GET | プロフィール編集 |
| `/mode/switch/{mode}` | GET | 表示モード切替 |

---

## 今後の拡張予定

- [ ] 製品レコメンデーション機能
- [ ] エクスポート機能（CSV/PDF）
- [ ] 通知機能（保証期限切れアラートなど）
- [ ] API公開（外部連携用）
- [ ] モバイルアプリ対応

---

*このドキュメントは Model Type プロジェクトの機能紹介として作成されました。*
